# Rubber Duck App - 機能仕様書

## コア機能

### 1. チャットインターフェース

**概要**: ユーザーがラバーダックに話しかけるためのチャットUI。

**仕様**:
- テキスト入力 → 送信 → ダックが「...」と返す
- メッセージはタイムスタンプ付きで時系列表示
- スクロールは最新メッセージに自動追従
- マークダウンやコードブロックは非対応（シンプルさ優先）

**ダックの応答パターン**:
| パターン | 確率 | 表示 |
|---------|------|------|
| 通常 | 91% | `...` |
| 疑問 | 5% | `...?` |
| 長考 | 3% | `......` |
| quack | 1% | `quack` |

応答はランダムで、1.0〜2.0秒のディレイ後に表示。
タイピングインジケーター（ドット点滅）を表示してから応答。

### 2. セッション管理

**概要**: 会話をセッション単位で管理・保存。

**仕様**:
- アプリ起動時に新しいセッションが自動作成される
- セッションには自動で日時ベースの名前が付く（例: `2026-02-09 21:30`）
- 「New Session」ボタンで明示的に新しいセッション開始
- セッションデータはJSONでローカル保存

**データ構造**:
```json
{
  "id": "session_1707456600000",
  "createdAt": "2026-02-09T12:30:00.000Z",
  "messages": [
    {
      "id": "msg_1",
      "sender": "user",
      "text": "なんでこのバグ直らないんだろう",
      "timestamp": "2026-02-09T12:30:15.000Z"
    },
    {
      "id": "msg_2",
      "sender": "duck",
      "text": "...",
      "timestamp": "2026-02-09T12:30:17.000Z"
    }
  ]
}
```

### 3. 履歴閲覧

**概要**: 過去のセッションを振り返れるサイドパネル。

**仕様**:
- サイドパネルとしてスライドイン表示
- セッション一覧は新しい順
- セッションをクリックすると内容を読み取り専用で表示
- 現在のセッションに戻るボタン

### 4. ダックアニメーション

**概要**: 画面上部に表示されるインタラクティブなダック。

**仕様**:
- アイドル時: ゆっくり上下に浮遊
- メッセージ受信時: 軽くバウンス
- クリック時: ぴょんと跳ねる
- SVGベースで描画、CSSアニメーションで動かす

### 5. 音声入力

**概要**: マイクボタンを押して声でダックに話しかけられる。

**技術**: whisper.cpp（ローカル音声認識） — 完全オフライン、API不要

**前提**: whisper-cli + ggml-base モデルがローカルにインストール済みであること

**フロー**:
```
マイクON → Web Audio API で PCM 録音（16kHz mono）
        → 無音検出（RMSベースVAD）で発話区間を自動区切り
        → IPC で main process に送信
        → whisper-cli で日本語転写
        → テキストを自動送信 → ダックが応答
        → 録音は継続（マイクOFFまで）
```

**仕様**:
- マイクボタンをクリックで録音開始/停止をトグル
- 日本語（`-l ja`）でローカル転写
- 約1.5秒の無音で発話区間を自動区切り
- 転写テキストは自動でチャットに送信（ダックが応答）
- 録音はマイクボタンを再度押すまで継続
- macOS: `systemPreferences.askForMediaAccess('microphone')` で権限要求
- Windows: OS側で自動ハンドリング
- インターネット接続不要

**UI状態**:
- `idle`: グレーのマイクアイコンボタン、"Talk to your duck..."
- `listening`: 赤いパルスアニメーション、"Listening..."
- `processing`: 黄色点滅（転写中）、"Transcribing..."
- `denied`: 半透明、操作不可

## サブ機能

### 6. カスタムタイトルバー

- OS標準のタイトルバーを非表示にし、カスタムデザイン
- ドラッグで移動可能（`-webkit-app-region: drag`）
- 閉じる/最小化/最大化ボタンは右上配置（Windows準拠）
- macOSではネイティブ信号機ボタンを表示

### 7. キーボードショートカット

| ショートカット | 機能 |
|-------------|------|
| `Enter` | メッセージ送信 |
| `Shift + Enter` | 改行入力 |
| `Cmd/Ctrl + N` | 新規セッション |
| `Cmd/Ctrl + H` | 履歴パネルトグル |
| `Escape` | 履歴パネルを閉じる |

## 将来的な拡張候補（v2以降）

- [ ] テーマ切り替え（ライトモード）
- [ ] エクスポート機能（Markdown出力）
- [ ] 通知リマインダー（「最近ダックと話してないよ」）
- [ ] ダックの着せ替え
- [ ] 統計ダッシュボード（セッション数、メッセージ数など）
